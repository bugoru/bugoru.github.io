var TCharts=function(a){'use strict';var c=Math.max;function b(a,b,c){let d=document.createElement(a);return Object.keys(b).forEach(a=>{d[a]=b[a]}),c&&c.appendChild(d),d}Array.prototype.flat||(Array.prototype.flat=function(){let a=[];return this.forEach(function(b){a=[...a,...b]}),a});class d{constructor(a){this.chart=a}render(){b("h1",{innerHTML:this.chart.title,className:"t charts header"},this.chart.container)}}class e{constructor(a,b){this.cursor=a,this.line=b,this.svg=this.cursor.sheet.svg,this.circle=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.circle.setAttribute("stroke",this.line.color),this.circle.setAttribute("visibility","hidden"),this.circle.setAttribute("stroke-width","2"),this.circle.setAttribute("r",4),this.render()}render(){this.svg.node.appendChild(this.circle)}draw(a,b){this.line.visible&&(this.circle.setAttribute("cx",b),this.circle.setAttribute("cy",this.svg.yValue(this.line.values[a])),this.circle.setAttribute("class","cursor circle"),this.circle.setAttribute("visibility","visible"))}hide(){this.circle.setAttribute("visibility","hidden")}}class f{constructor(a){this.sheet=a,this.chart=this.sheet.chart,this.line=document.createElementNS("http://www.w3.org/2000/svg","line"),this.line.setAttribute("class","grid line"),this.line.setAttribute("stroke-width","2"),this.line.setAttribute("fill","none"),this.circles=this.chart.lines.map(a=>new e(this,a)),this.render()}render(){this.sheet.svg.node.prepend(this.line)}hide(){this.line.setAttribute("visibility","hidden"),this.circles.forEach(a=>a.hide())}draw(a){let b=this.chart.xValue(a);this.line.setAttribute("visibility","visible"),this.line.setAttribute("x1",b),this.line.setAttribute("x2",b),this.line.setAttribute("y1",0),this.line.setAttribute("y2",this.sheet.height),this.circles.forEach(c=>c.draw(a,b))}}class g{constructor(a){this.yaxis=a,this.sheet=a.sheet,this.line=document.createElementNS("http://www.w3.org/2000/svg","line"),this.line.setAttribute("class","grid line"),this.line.setAttribute("stroke-width","1"),this.line.setAttribute("fill","none"),this.line.setAttribute("x1",0),this.line.setAttribute("x2",this.sheet.width),this.text=document.createElementNS("http://www.w3.org/2000/svg","text"),this.text.setAttribute("x",0),this.text.setAttribute("class","yAxis label"),this.render()}render(){this.sheet.svg.node.prepend(this.text),this.sheet.svg.node.prepend(this.line)}hide(){this.line.setAttribute("visibility","hidden"),this.text.setAttribute("visibility","hidden")}show(){this.line.setAttribute("visibility","visible"),this.text.setAttribute("visibility","visible")}set value(a){this._value=a,this.y=this.sheet.svg.yValue(a),this.y>this.sheet.height?this.hide():this.draw()}get value(){return this._value}set textValue(a){this._textValue=a}get textValue(){return this._textValue?this._textValue:1e6<=this.value&&0==this.value%1e4?this.value/1e6+"M":1e4<=this.value&&0==this.value%100?this.value/1e3+"k":this.value}draw(){this.show(),this.text.setAttribute("y",this.y-5),this.text.innerHTML=this.textValue,this.line.setAttribute("y1",this.y),this.line.setAttribute("y2",this.y)}}class h{constructor(a){this.sheet=a,this.chart=a.chart,this.labelsCount=6,this.render()}render(){this.labels=Array.from(Array(this.labelsCount)).map(()=>new g(this)),this.draw()}round(a){var b=Math.abs,c=Math.pow,d=Math.round,e=Math.log10;let f=d(e(a))-1;return+(d(a/c(10,f))*c(10,f)).toFixed(b(f))}draw(a=this.chart.maxValue){if(isFinite(a)){let b=0==this.sheet.minValueOffset?0:this.round(this.sheet.minValueOffset),c=this.round((a-b)/this.labelsCount);this.labels.forEach((a,d)=>{a.value=d*c+b})}else this.labels.forEach(a=>{a.hide()})}}class i{constructor(a,b){this.info=a,this.line=b,this.render()}render(){this.container=b("div",{className:"value",style:`color: ${this.line.color}`},this.info.valuesContainer),this.number=b("div",{className:"number"},this.container),this.name=b("div",{className:"name",innerHTML:this.line.name},this.container)}draw(a){this.line.visible?(this.container.style.display="block",this.number.innerHTML=this.line.values[a]):this.container.style.display="none"}}const j=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],k=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];class l{constructor(a){this.date=new Date(a)}get monthDate(){return`${j[this.date.getMonth()]} ${this.date.getDate()}`}get dayMonthDate(){return`${k[this.date.getDay()]}, ${this.monthDate}`}}const m=10;class n{constructor(a){this.sheet=a,this.chart=a.chart,this.render()}render(){this.container=b("div",{className:"info",style:"display:none;"},this.sheet.container),this.title=b("div",{className:"title"},this.container),this.valuesContainer=b("div",{className:"values"},this.container),this.values=this.chart.lines.map(a=>new i(this,a))}titleText(a){if(this.chart.renderInfo)return this.chart.renderInfo(a);else{let b=new l(a);return b.dayMonthDate}}draw(a){this.container.style.display="block",this.title.innerHTML=this.titleText(this.chart.xAxis.values[a]),this.values.forEach(b=>b.draw(a));let b=this.chart.xValue(a);b=b+m+this.container.offsetWidth>this.sheet.width?b-this.container.offsetWidth-m:b+m,this.container.style.left=b+"px"}hide(){this.container.style.display="none"}}class o{constructor(a,b){this.svg=a,this.line=b,this.width=this.svg.container.offsetWidth,this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.path.setAttribute("stroke",this.line.color),this.path.setAttribute("stroke-width","2"),this.path.setAttribute("fill","none")}draw(){this.points=this.line.values.map((a,b)=>[this.svg.xValue(b),this.svg.yValue(a)]),this.path.style.visibility=this.line.visible?"visible":"hidden",this.path.setAttribute("d",`M ${this.points[0]} L ${this.points.slice(1)}`)}vScale(){}}class p{constructor(a,b,c=0,d=0){this.chart=a,this.container=b,this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.pathes=this.chart.lines.map(a=>new o(this,a)),this.paddingTop=c,this.paddingLeft=d,this.setDimensions(),this.render()}render(){this.container.appendChild(this.svg),this.pathes.forEach(({path:a})=>this.svg.appendChild(a))}setDimensions(){let a=this.chart.minValue;this.minValueOffset=this.chart.vScroll?a>=this.chart.maxValue/3?.9*a:0:0,this.dx=this.container.offsetWidth/this.chart.maxValuesLength,this.dy=this.getDy()}getDy(a=this.chart.maxValue){return(this.container.offsetHeight-this.paddingTop)/(a-this.minValueOffset)}draw(a,b){this.scale=a,this.scrollOffset=b,this.pathes.forEach(a=>a.draw())}xValue(a){return a*this.dx*this.scale-this.scrollOffset+this.paddingLeft}yValue(a){return this.container.offsetHeight-(a-this.minValueOffset)*this.dy}get node(){return this.svg}}const q=8;class r{constructor(a){this.chart=a,document.addEventListener("mousemove",a=>this.findIndex(a)),this.cursorFixed=!1}render(){this.container=b("div",{className:"t charts sheet",onmousedown:a=>this.toggleFixCursor(a)},this.chart.container),this.svg=new p(this.chart,this.container,5,5,5),this.cursor=new f(this),this.info=new n(this),this.yaxis=new h(this),this.draw()}update(){this.svg.setDimensions(),this.draw()}get width(){return this.container.offsetWidth}get height(){return this.container.offsetHeight}get minValueOffset(){return this.svg.minValueOffset}draw(){this.svg.draw(this.chart.scale,this.chart.scrollOffset),this.xGrid=this.chart.xGrid,this.dx=this.chart.dx,this.hideCursor()}redraw(a,b=null){this.svg.dy=b||this.svg.getDy(a),this.svg.draw(this.chart.scale,this.chart.scrollOffset),this.yaxis.draw(a)}findIndex(a){if(this.container.contains(a.target)){let b=a.pageX-this.container.offsetLeft;this.index=this.xGrid.findIndex(a=>0<=a&&b>=a-this.dx/2&&b<=a+this.dx/2&&a<=this.width)}else this.index=-1}set index(a){if(!this.cursorFixed){this.indexWas=this._index,this._index=a;try{-1<this._index?(this.cursor.draw(this._index),this.info.draw(this._index)):(this.cursor.hide(),this.info.hide())}catch(a){}}}get index(){return this._index}hideCursor(){this.cursorFixed=!1,this.index=-1}toggleFixCursor(a){this.isValidHandler(a)&&(this.cursorFixed=!this.cursorFixed,this.findIndex(a))}isValidHandler(a){return a.target==this.svg.node||a.target.parentNode==this.svg.node||a.target==this.container}vScaleIn(a=!0){let b=c(...this.chart.visibleValues);a?this.animateVScale(b):this.redraw(b)}vScaleOut(){this.animateVScale(this.chart.maxValue)}animateVScale(a){this.waitAnimationTimeout&&clearTimeout(this.waitAnimationTimeout),this.animationInProgress?this.waitAnimationTimeout=setTimeout(()=>this.animateVScale(a),50):(this.hideCursor(),this.animationInProgress=!0,this.animate((this.svg.getDy(a)-this.svg.dy)/q,a))}animate(a,b,c=0){this.redraw(b,this.svg.dy+a),(c+=1)<q?requestAnimationFrame(()=>this.animate(a,b,c)):this.animationInProgress=!1}}class s{constructor(a){this.chart=a,this.onStartDrag=this.onStartDrag.bind(this),this.onEndDrag=this.onEndDrag.bind(this),this.onChange=this.onChange.bind(this)}render(){this.container=b("div",{className:"t charts preview"},this.chart.container),this.leftOverlay=b("div",{className:"left overlay"},this.container),this.window=b("div",{className:"window",onmousedown:this.onStartDrag,ondragstart:()=>!1},this.container),this.window.addEventListener("touchstart",this.onStartDrag),this.rightOverlay=b("div",{className:"right overlay"},this.container),this.leftHandler=b("div",{className:"left handler"},this.window),this.rightHandler=b("div",{className:"right handler"},this.window),this.window.style.width=this.container.offsetWidth/this.chart.scale+"px",this.leftOverlay.style.width=(this.container.offsetWidth-this.window.offsetWidth)*this.chart.scroll+"px",this.rightOverlay.style.width=this.container.offsetWidth-this.leftOverlay.offsetWidth-this.window.offsetWidth+"px",this.svg=new p(this.chart,this.container),this.svg.draw(1,0)}update(){this.svg.setDimensions(),this.svg.draw(1,0)}pageXFromEvent(a){return a.touches?a.touches[0].pageX:a.pageX}onStartDrag(a){switch(this.startMouseX=this.pageXFromEvent(a),this.chart.sheet.vScaleOut(),a.target){case this.leftHandler:this.leftOverlay.style.flex="auto",this.window.style.maxWidth=this.container.offsetWidth-this.rightOverlay.offsetWidth+"px",this.originWidth=this.window.offsetWidth,this.calculateWidth=a=>{this.window.style.width=this.originWidth+(this.startMouseX-a)+"px"};break;case this.window:this.rightOverlay.style.flex="auto",this.leftOverlay.style.maxWidth=this.container.offsetWidth-this.window.offsetWidth+"px",this.originWidth=this.leftOverlay.offsetWidth,this.calculateWidth=a=>{let b=this.originWidth-(this.startMouseX-a);this.leftOverlay.style.width=(0<b?b:0)+"px"};break;case this.rightHandler:this.rightOverlay.style.flex="auto",this.window.style.maxWidth=this.container.offsetWidth-this.leftOverlay.offsetWidth+"px",this.originWidth=this.window.offsetWidth,this.calculateWidth=a=>this.window.style.width=this.originWidth+(a-this.startMouseX)+"px";}document.addEventListener("mousemove",this.onChange),document.addEventListener("mouseup",this.onEndDrag),document.addEventListener("touchmove",this.onChange),document.addEventListener("touchend",this.onEndDrag)}onChange(a){this.calculateWidth(this.pageXFromEvent(a)),this.chart.redraw(this.scaleValue,this.scrollValue)}onEndDrag(){this.commitSizes(),document.removeEventListener("mousemove",this.onChange),document.removeEventListener("mouseup",this.onEndDrag),document.removeEventListener("touchmove",this.onChange),document.removeEventListener("touchend",this.onEndDrag),this.chart.sheet.vScaleIn()}commitSizes(){[this.leftOverlay,this.window,this.rightOverlay].forEach(a=>{a.style.width=a.offsetWidth+"px",a.style.maxWidth=null,a.style.flex="none"})}get scrollValue(){return this.leftOverlay.offsetWidth/(this.container.offsetWidth-this.window.offsetWidth)}get scaleValue(){return 1/(this.window.offsetWidth/this.container.offsetWidth)}}class t{constructor(a,b){this.chart=a.chart,this.legend=a,this.line=b,this.render()}render(){this.container=b("div",{className:"item",onclick:()=>this.toggleLine()},this.legend.container),this.checkbox=b("div",{className:"checkbox",style:`background-color: ${this.line.color}; border-color: ${this.line.color}`,innerHTML:"\u2713"},this.container),b("div",{className:"label",innerHTML:this.line.name},this.container)}toggleLine(){this.line.visible=!this.line.visible,this.line.visible?(this.checkbox.style.backgroundColor=this.line.color,this.checkbox.innerHTML="\u2713"):(this.checkbox.style.backgroundColor=null,this.checkbox.innerHTML=""),this.chart.update()}}class u{constructor(a){this.chart=a}render(){this.container=b("div",{className:"t charts legend"},this.chart.container),this.items=this.chart.lines.map(a=>new t(this,a))}}class v{constructor(a,b){this.key=b,this.color=a.data.colors[this.key],this.name=a.data.names[this.key],this.values=(a.data.columns.find(a=>a[0]===b)||[]).slice(1),this.visible=!0}}class w{constructor(a,c){this.xaxis=a,this.chart=this.xaxis.chart,this.container=b("div",{className:"label"},this.xaxis.container),this.index=c}textValue(a){if(this.chart.renderLabel)return this.chart.renderLabel(a);else{let b=new l(a);return b.monthDate}}get x(){return this.chart.xValue(this._index)}set index(a){this._index=a,this.draw()}get indexOffset(){return this.xaxis.labelStep*this.xaxis.labelsCount}move(){this.x<-1*this.xaxis.labelWidth?this.index=this._index+this.indexOffset:this.x>=this.xaxis.container.offsetWidth&&(this.index=this._index-this.indexOffset),this.draw()}draw(){this.container.style.left=this.x-1+"px";let a=this.xaxis.values[this._index];this.container.innerHTML=a?this.textValue(a):""}}class x{constructor(a,b){this.chart=a,this.key=b,this.values=(this.chart.data.columns.find(a=>a[0]===b)||[]).slice(1),this.labelsCount=this.chart.labelsCount||10,this.lastScale=this.chart.scale}render(){this.container=b("div",{className:"t charts xAxis"},this.chart.container),this.labelWidth=this.container.offsetWidth/this.labelsCount,this.labels=Array.from(Array(this.labelsCount)).map(()=>new w(this)),this.draw()}draw(){var a=Math.ceil;this.labelStepWas=this.labelStep;let b=a(this.container.offsetWidth/this.chart.dx/(this.labelsCount-1));this.labelStep=1>b?1:b,this.firstVisibleIndex=this.chart.getVisibleIndexes()[0],this.labelStepChanged||0==this.chart.scroll?this.labels.forEach((a,b)=>{a.index=this.labelIndex(b)}):this.labels.forEach(a=>a.move())}labelIndex(a){return this.firstVisibleIndex+a*this.labelStep}get labelStepChanged(){return this.labelStep!=this.labelStepWas}}class y{constructor(a,b){if(this.title=b.title,this.data=b.data,this.scale=b.scale||5,this.scroll=1*b.scroll,this.container=document.getElementById(a),this.renderLabel=b.renderLabel,this.renderInfo=b.renderInfo,this.vScroll=b.vScroll,!this.container){throw`Element with #${a} not found`}if(!this.isDataValid()){throw`Invalid chart data`}this.lines=this.createLines(),this.xAxis=this.createXAxis(),this.header=new d(this),this.sheet=new r(this),this.preview=new s(this),this.legend=new u(this),this.dark=b.dark,this.render()}render(){this.clearContainer(),this.container.className+=" t charts container",this.header.render(),this.sheet.render(),this.xAxis.render(),this.preview.render(),this.legend.render(),this.sheet.vScaleIn(!1)}redraw(a,b){this.scale=a,this.scroll=b,this.sheet.draw(),this.xAxis.draw()}update(){this.sheet.update(),this.preview.update(),this.sheet.vScaleIn()}get scrollOffset(){return 1==this.scale?0:this.sheet.container.offsetWidth*this.scale*this.scroll-this.sheet.container.offsetWidth*this.scroll}clearContainer(){this.container.childNodes.forEach(function(a){a.remove()})}isDataValid(){return this.data&&this.data.columns instanceof Array&&this.data.types instanceof Object||!1}createLines(){return Object.entries(this.data.types).filter(([a,b])=>"line"===b).map(([a,b])=>new v(this,a))}createXAxis(){let a=Object.entries(this.data.types).find(([a,b])=>"x"===b)[0];return new x(this,a)}get maxValue(){return c(...this.visibleLines.map(a=>a.values).flat())}get minValue(){var a=Math.min;return a(...this.visibleLines.map(a=>a.values).flat())}get maxValuesLength(){return c(...this.lines.map(a=>a.values.length))}get visibleLines(){return this.lines.filter(a=>a.visible)}xValue(a){return this.sheet.svg.xValue(a)}yValue(a){return this.sheet.svg.yValue(a)}isVisible(a){return 0<=a&&a<=this.sheet.container.offsetWidth}getVisibleIndexes(){let a=[];for(let b=0;b<this.maxValuesLength;b++)this.isVisible(this.xValue(b))&&a.push(b);return a}get visibleValues(){let a=this.getVisibleIndexes();return this.visibleLines.map(b=>a.map(a=>b.values[a])).flat()}get xGrid(){return Array.from(Array(this.maxValuesLength)).map((a,b)=>this.xValue(b))}get dx(){return this.sheet.width/this.maxValuesLength*this.scale}set dark(a){this._dark=a,this._dark?this.container.className+=" dark":this.container.className=this.container.className.replace(/dark/g,"")}get dark(){return this._dark}toggleDark(){this.dark=!this.dark}}return a.Chart=y,a}({});
